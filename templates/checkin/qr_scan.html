{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans '扫码签到' %} - {{ block.super }}{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body p-3">
        <h4 class="mb-3">{% trans '请在手机上完成扫码签到' %}</h4>
        <p class="text-muted small mb-2">{% trans '授予摄像头权限后，对准二维码即可识别。' %}</p>
        <div class="ratio ratio-4x3 border rounded bg-dark mb-2">
          <video id="video" playsinline style="width:100%; height:100%; object-fit:cover;"></video>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="start-btn">{% trans '打开摄像头' %}</button>
          <button class="btn btn-outline-secondary" id="stop-btn">{% trans '停止' %}</button>
        </div>
        <div class="mt-2" id="status" class="text-muted small"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
(function(){
  const video = document.getElementById('video');
  const startBtn = document.getElementById('start-btn');
  const stopBtn = document.getElementById('stop-btn');
  const statusEl = document.getElementById('status');
  let stream = null, rafId = null;

  function setStatus(msg){ statusEl.textContent = msg; }

  async function getLocation(){
    return new Promise(resolve => {
      if (!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        pos => resolve({lat: pos.coords.latitude, lng: pos.coords.longitude}),
        () => resolve(null),
        {enableHighAccuracy: true, timeout: 5000}
      );
    });
  }

  function isSecure(){
    if (window.isSecureContext) return true;
    const host = window.location.hostname;
    return host === 'localhost' || host === '127.0.0.1';
  }

  async function postCheckIn(token){
    try {
      const loc = await getLocation();
      const form = new FormData();
      form.append('csrfmiddlewaretoken', getCsrf());
      form.append('qr_token', token);
      if (loc){ form.append('lat', String(loc.lat)); form.append('lng', String(loc.lng)); }
      const res = await fetch("{% url 'checkin:checkin_api' activity.id %}", { method: 'POST', body: form });
      const data = await res.json();
      if (data.success){
        setStatus("{% trans '签到成功' %}");
        window.location.href = "{% url 'checkin:dashboard' %}";
      }else{
        alert(data.error || "{% trans '签到失败' %}");
      }
    } catch(err){
      alert("{% trans '网络错误，请重试' %}");
    }
  }

  function getCsrf(){
    const m = document.cookie.match(/csrftoken=([^;]+)/); return m ? m[1] : '';
  }

  function stop(){
    if (rafId) cancelAnimationFrame(rafId);
    if (stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
    setStatus('');
  }

  async function start(){
    try{
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert("{% trans '摄像头不可用，请检查浏览器权限或设备' %}");
        return;
      }
      if (!isSecure()){
        alert("{% trans '无法在非安全环境打开摄像头，请使用 HTTPS 或 localhost 访问' %}");
        return;
      }
      stop();
      setStatus("{% trans '正在请求摄像头权限...' %}");
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream; video.play();
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const scan = () => {
        if (!video.videoWidth) { rafId = requestAnimationFrame(scan); return; }
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imgData.data, canvas.width, canvas.height);
        if (code && code.data){
          stop();
          postCheckIn(code.data);
          return;
        }
        setStatus("{% trans '正在扫描...' %}");
        rafId = requestAnimationFrame(scan);
      };
      scan();
    }catch(err){
      alert("{% trans '无法打开摄像头，请检查权限' %}");
    }
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
})();
</script>
{% endblock %}
