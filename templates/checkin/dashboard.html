{% extends 'base.html' %}
{% load i18n %}
{% block title %}签到 - {{ block.super }}{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">{% trans '可参与活动' %}</h3>
    <span class="text-muted">{% trans '当前时间' %}：{{ current_time }}</span>
</div>
{% if activities %}
    <div class="row g-3">
        {% for item in activities %}
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title mb-1">{{ item.activity.name }}</h5>
                                <div class="text-muted small">{% trans '时间' %}：{{ item.activity.start_time }} - {{ item.activity.end_time }}</div>
                                <div class="text-muted small">{% trans '创建人' %}：{{ item.activity.created_by.first_name|default:item.activity.created_by.student_id }}</div>
                            </div>
                            {% if item.has_checked_in %}
                                <span class="badge bg-success">{% trans '已签到' %}</span>
                            {% endif %}
                        </div>
                        {% if item.has_checked_in %}
                            <div class="text-muted small">{% trans '签到时间' %}：{{ item.checkin_time }}</div>
                        {% else %}
                            <form method="post" action="{% url 'checkin:checkin_api' item.activity.id %}" data-checkin-form>
                                {% csrf_token %}
                                <button class="btn btn-primary w-100" type="submit">{% trans '立即签到' %}</button>
                            </form>
                        {% endif %}

                        {% if item.is_creator and item.activity.qr_enabled %}
                        <div class="mt-3 border rounded p-2 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">{% trans '发起人二维码（实时刷新）' %}</span>
                                <small class="text-muted">{% blocktrans %}每 {{ item.qr_interval }} 秒{% endblocktrans %}</small>
                            </div>
                            <img data-qr-img src="{% url 'checkin:qr_image' item.activity.id %}" data-interval="{{ item.qr_interval }}" class="img-fluid" style="max-width: 220px;" alt="QR">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info">{% trans '当前没有可签到的活动。' %}</div>
{% endif %}
{% endblock %}
{% block extra_js %}
<script>
// Simple AJAX post for check-in buttons
const forms = document.querySelectorAll('[data-checkin-form]');
forms.forEach(form => {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const res = await fetch(form.action, {
            method: 'POST',
            headers: {'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value},
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || '签到失败');
        }
    });
});

// auto-refresh QR for creators
document.querySelectorAll('[data-qr-img]').forEach(img => {
    const interval = Math.max(parseInt(img.dataset.interval || '30', 10), 10) * 1000;
    setInterval(() => {
        img.src = img.src.split('?')[0] + '?t=' + Date.now();
    }, interval);
});
</script>
{% endblock %}
