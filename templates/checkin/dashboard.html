{% extends 'base.html' %}
{% block title %}签到 - {{ block.super }}{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
    <h3>可参与活动</h3>
    <span class="text-muted">当前时间：{{ current_time }}</span>
</div>
{% if activities %}
    <div class="list-group">
        {% for item in activities %}
            <div class="list-group-item d-flex align-items-center justify-content-between">
                <div>
                    <h5 class="mb-1">{{ item.activity.name }}</h5>
                    <small class="text-muted">时间：{{ item.activity.start_time }} - {{ item.activity.end_time }}</small><br>
                    <small class="text-muted">创建人：{{ item.activity.created_by.first_name|default:item.activity.created_by.student_id }}</small>
                </div>
                <div>
                    {% if item.has_checked_in %}
                        <span class="badge bg-success">已签到 {{ item.checkin_time }}</span>
                    {% else %}
                        <form method="post" action="{% url 'checkin:checkin_api' item.activity.id %}" class="d-inline" data-checkin-form>
                            {% csrf_token %}
                            <button class="btn btn-primary" type="submit">签到</button>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info">当前没有可签到的活动。</div>
{% endif %}
{% endblock %}
{% block extra_js %}
<script>
// Simple AJAX post for check-in buttons
const forms = document.querySelectorAll('[data-checkin-form]');
forms.forEach(form => {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const res = await fetch(form.action, {
            method: 'POST',
            headers: {'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value},
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || '签到失败');
        }
    });
});
</script>
{% endblock %}
