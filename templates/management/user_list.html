{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans '用户管理' %} - {{ block.super }}{% endblock %}
{% block content %}
<h3 class="mb-3">{% trans '用户管理' %}</h3>

<div class="row g-3">
    <!-- 用户列表：主列 -->
    <div class="col-12 col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white py-2">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                    <form class="d-flex align-items-center gap-2" method="get">
                        <div class="input-group" style="max-width: 440px;">
                            <span class="input-group-text">{% trans '搜索' %}</span>
                            <input type="text" class="form-control" name="q" value="{{ query }}" placeholder="{% trans '学号或姓名' %}">
                            <button class="btn btn-light" type="submit">{% trans '搜索' %}</button>
                        </div>
                    </form>
                    <button class="btn btn-outline-light" type="button" id="clear-selection">{% trans '清除选择' %}</button>
                </div>
            </div>
            <div class="card-body vstack gap-3">
                <div id="bulk-actions" class="d-flex flex-wrap align-items-center gap-2">
                    <div class="text-muted" id="selected-count" data-start="{% trans '已选' %}" data-end="{% trans '个' %}">{% trans '已选' %} 0 {% trans '个' %}</div>
                    <select name="format" class="form-select" style="width: 160px;" form="user-action-form">
                        <option value="xlsx">{% trans '导出 XLSX' %}</option>
                        <option value="csv">{% trans '导出 CSV' %}</option>
                    </select>
                    <button class="btn btn-primary" type="submit" form="user-action-form" formaction="{% url 'management:user_bulk_reset' %}">{% trans '批量重置并导出' %}</button>
                    <button class="btn btn-danger" type="submit" form="user-action-form" formaction="{% url 'management:user_bulk_delete' %}" onclick="return confirm('{% trans '确认删除选中用户？（管理员不会被删除）' %}')">{% trans '批量删除' %}</button>
                    <div class="input-group" style="width: 240px;">
                        <span class="input-group-text">{% trans '身份' %}</span>
                        <select id="role-select" name="role" class="form-select" form="user-action-form">
                            <option value="normal">{% trans '普通用户' %}</option>
                            <option value="staff">{% trans '后台管理员' %}</option>
                            <option value="admin">{% trans '系统管理员' %}</option>
                        </select>
                    </div>
                    <button class="btn btn-outline-secondary" type="submit" form="user-action-form" formaction="{% url 'management:user_bulk_role' %}">{% trans '设置' context 'action' %}</button>
                </div>

                <form id="user-action-form" method="post">
                    {% csrf_token %}
                    <div id="selected-hidden"></div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th style="width:48px;"><input type="checkbox" id="select-all"></th>
                                    <th>{% trans '学号' %}</th>
                                    <th>{% trans '姓名' %}</th>
                                    <th>{% trans '身份' %}</th>
                                    <th>{% trans '启用' %}</th>
                                    <th>{% trans '首次登录' %}</th>
                                    <th class="text-end">{% trans '操作' %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in page_obj %}
                                {% with protected_admin=user.is_admin %}{% with protected_super=user.is_superuser %}
                                <tr>
                                    <td><input type="checkbox" name="user_ids" value="{{ user.id }}" {% if protected_admin or protected_super %}disabled{% endif %}></td>
                                    <td class="fw-semibold">{{ user.student_id }}</td>
                                    <td>{{ user.first_name|default:'-' }}</td>
                                    <td>
                                        {% if user.is_superuser %}
                                            <span class="badge bg-danger">{% trans '系统管理员' %}</span>
                                        {% elif user.is_admin %}
                                            <span class="badge bg-primary">{% trans '系统管理员' %}</span>
                                        {% elif user.is_staff %}
                                            <span class="badge bg-info text-dark">{% trans '后台管理员' %}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{% trans '普通' context 'role' %}</span>
                                        {% endif %}
                                    </td>
                                    <td>{% if user.is_active %}<span class="badge bg-success">{% trans '是' %}</span>{% else %}<span class="badge bg-danger">{% trans '否' %}</span>{% endif %}</td>
                                    <td>{% if user.first_login %}<span class="badge bg-warning text-dark">{% trans '是' %}</span>{% else %}<span class="badge bg-success">{% trans '否' %}</span>{% endif %}</td>
                                    {% if protected_admin or protected_super %}
                                        <td class="text-end">
                                            <span class="text-muted small d-block">{% trans '管理员受保护' %}</span>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-primary" type="submit" form="user-action-form" formaction="{% url 'management:user_reset' user.id %}" formmethod="post">{% trans '重置密码' %}</button>
                                                <button class="btn btn-outline-danger" type="submit" form="user-action-form" formaction="{% url 'management:user_delete' user.id %}" formmethod="post" onclick="return confirm('{% trans '确认删除该用户?' %}')">{% trans '删除' %}</button>
                                            </div>
                                        </td>
                                    {% else %}
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-primary" type="submit" form="user-action-form" formaction="{% url 'management:user_reset' user.id %}" formmethod="post">{% trans '重置密码' %}</button>
                                                <button class="btn btn-outline-danger" type="submit" form="user-action-form" formaction="{% url 'management:user_delete' user.id %}" formmethod="post" onclick="return confirm('{% trans '确认删除该用户?' %}')">{% trans '删除' %}</button>
                                            </div>
                                        </td>
                                    {% endif %}
                                </tr>
                                {% endwith %}{% endwith %}
                                {% empty %}
                                    <tr><td colspan="7" class="text-center text-muted">{% trans '暂无用户' %}</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
                <nav aria-label="用户分页" class="mt-2">
                    <ul class="pagination mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query }}">{% trans '上一页' %}</a></li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">{% trans '上一页' %}</span></li>
                        {% endif %}
                        <li class="page-item disabled"><span class="page-link">{% blocktrans with current=page_obj.number total=page_obj.paginator.num_pages %}第 {{ current }} / {{ total }} 页{% endblocktrans %}</span></li>
                        {% if page_obj.has_next %}
                            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query }}">{% trans '下一页' %}</a></li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">{% trans '下一页' %}</span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 批量创建：侧栏 -->
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white py-2">{% trans '批量创建用户' %}</div>
            <div class="card-body">
                <form method="post" action="{% url 'management:user_bulk_create' %}" class="vstack gap-2" enctype="multipart/form-data">
                    {% csrf_token %}
                    <textarea name="student_ids" class="form-control" rows="4" placeholder="{% trans '每行或空格分隔学号，支持 1234567890 张三 格式' %}"></textarea>
                    <input type="file" name="csv_file" accept=".csv" class="form-control">
                    <div class="d-flex gap-2 align-items-center">
                        <select name="format" class="form-select" style="max-width: 180px;">
                            <option value="xlsx">{% trans '导出 XLSX' %}</option>
                            <option value="csv">{% trans '导出 CSV' %}</option>
                        </select>
                        <button class="btn btn-secondary" type="submit">{% trans '生成' %}</button>
                    </div>
                    <div class="form-text">{% trans '支持上传 CSV（列：学号, 可选姓名）。' %}</div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
const STORAGE_KEY = 'management_user_selected_ids';
const CLEAR_FLAG = 'management_user_clear_after_action';
let selectedIds = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

// Clear selection after a completed action redirect
if (sessionStorage.getItem(CLEAR_FLAG)) {
    selectedIds.clear();
    localStorage.removeItem(STORAGE_KEY);
    sessionStorage.removeItem(CLEAR_FLAG);
}

const selectedHidden = document.getElementById('selected-hidden');
const selectAll = document.getElementById('select-all');
const clearSelectionBtn = document.getElementById('clear-selection');
const selectedCountLabel = document.getElementById('selected-count');

function saveSelection() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(selectedIds)));
}

function syncCheckboxes() {
    document.querySelectorAll('input[name="user_ids"]').forEach(cb => {
        cb.checked = selectedIds.has(cb.value);
    });
}

function updateSelectAllState() {
    const checkboxes = Array.from(document.querySelectorAll('input[name="user_ids"]:not(:disabled)'));
    const checked = checkboxes.filter(cb => cb.checked);
    if (!selectAll) return;
    selectAll.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
}

function updateCounter() {
    if (selectedCountLabel) {
        const start = selectedCountLabel.dataset.start || '已选';
        const end = selectedCountLabel.dataset.end || '个';
        selectedCountLabel.textContent = `${start} ${selectedIds.size} ${end}`;
    }
}

function attachHiddenInputs() {
    if (!selectedHidden) return;
    selectedHidden.innerHTML = '';
    selectedIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'user_ids';
        input.value = id;
        selectedHidden.appendChild(input);
    });
}

function handleCheckboxChange(e) {
    const cb = e.target;
    if (cb.checked) {
        selectedIds.add(cb.value);
    } else {
        selectedIds.delete(cb.value);
    }
    saveSelection();
    updateSelectAllState();
    updateCounter();
}

function initCheckboxes() {
    syncCheckboxes();
    updateSelectAllState();
    updateCounter();
    document.querySelectorAll('input[name="user_ids"]').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
    });
}

if (selectAll) {
    selectAll.addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('input[name="user_ids"]:not(:disabled)');
        checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
            if (cb.checked) {
                selectedIds.add(cb.value);
            } else {
                selectedIds.delete(cb.value);
            }
        });
        saveSelection();
        updateSelectAllState();
        updateCounter();
    });
}

if (clearSelectionBtn) {
    clearSelectionBtn.addEventListener('click', () => {
        selectedIds.clear();
        saveSelection();
        syncCheckboxes();
        updateSelectAllState();
        updateCounter();
    });
}

const actionForm = document.getElementById('user-action-form');
if (actionForm) {
    actionForm.addEventListener('submit', () => {
        sessionStorage.setItem(CLEAR_FLAG, '1');
        attachHiddenInputs();
    });
}

document.addEventListener('DOMContentLoaded', () => {
    initCheckboxes();
});
</script>
{% endblock %}
