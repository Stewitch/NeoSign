{% extends 'base.html' %}
{% block title %}用户管理 - {{ block.super }}{% endblock %}
{% block content %}
<h3 class="mb-3">用户管理</h3>

<div class="row g-3">
    <!-- 左侧：批量创建（半宽） -->
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white py-2">批量创建用户</div>
            <div class="card-body">
                <form method="post" action="{% url 'management:user_bulk_create' %}" class="vstack gap-2" enctype="multipart/form-data">
                    {% csrf_token %}
                    <textarea name="student_ids" class="form-control" rows="4" placeholder="每行或空格分隔学号，支持 1234567890 张三 格式"></textarea>
                    <input type="file" name="csv_file" accept=".csv" class="form-control">
                    <div class="d-flex gap-2 align-items-center">
                        <select name="format" class="form-select" style="max-width: 180px;">
                            <option value="xlsx">导出 XLSX</option>
                            <option value="csv">导出 CSV</option>
                        </select>
                        <button class="btn btn-secondary" type="submit">生成</button>
                    </div>
                    <div class="form-text">支持上传 CSV（列：学号, 可选姓名）。</div>
                </form>
            </div>
        </div>
    </div>

    <!-- 右侧：用户列表（半宽） -->
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
                <div class="d-flex flex-wrap justify-content-between align-items-center w-100 gap-2">
                    <form class="d-flex align-items-center gap-2" method="get">
                        <div class="input-group" style="max-width: 320px;">
                            <span class="input-group-text">搜索</span>
                            <input type="text" class="form-control" name="q" value="{{ query }}" placeholder="学号或姓名">
                            <button class="btn btn-light" type="submit">搜索</button>
                        </div>
                    </form>
                    <div id="bulk-actions" class="d-flex flex-wrap align-items-center gap-2">
                        <div class="text-white-50" id="selected-count">已选 0 个</div>
                        <select name="format" class="form-select" style="width: 150px;" form="user-action-form">
                            <option value="xlsx">导出为 XLSX</option>
                            <option value="csv">导出为 CSV</option>
                        </select>
                        <button class="btn btn-primary" type="submit" form="user-action-form" formaction="{% url 'management:user_bulk_reset' %}">批量重置并导出</button>
                        <button class="btn btn-danger" type="submit" form="user-action-form" formaction="{% url 'management:user_bulk_delete' %}" onclick="return confirm('确认删除选中用户？（管理员不会被删除）')">批量删除</button>
                        <div class="input-group" style="width: 240px;">
                            <span class="input-group-text">身份</span>
                            <select id="role-select" name="role" class="form-select" form="user-action-form">
                                <option value="normal">普通用户</option>
                                <option value="staff">后台管理员</option>
                                <option value="admin">系统管理员</option>
                            </select>
                            <button class="btn btn-outline-light" type="submit" form="user-action-form" formaction="{% url 'management:user_bulk_role' %}">设置</button>
                        </div>
                        <button class="btn btn-outline-light" type="button" id="clear-selection">清除选择</button>
                    </div>
                </div>
            </div>
            <form id="user-action-form" method="post">
                {% csrf_token %}
                <div id="selected-hidden"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>学号</th>
                                <th>姓名</th>
                                <th>身份</th>
                                <th>启用</th>
                                <th>首次登录</th>
                                <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in page_obj %}
                            {% with protected_admin=user.is_admin %}{% with protected_super=user.is_superuser %}
                            <tr>
                                <td><input type="checkbox" name="user_ids" value="{{ user.id }}" {% if protected_admin or protected_super %}disabled{% endif %}></td>
                                <td class="fw-semibold">{{ user.student_id }}</td>
                                <td>{{ user.first_name|default:'-' }}</td>
                                <td>
                                    {% if user.is_superuser %}<span class="badge bg-danger">系统管理员</span>
                                    {% elif user.is_admin %}<span class="badge bg-primary">系统管理员</span>
                                    {% elif user.is_staff %}<span class="badge bg-info text-dark">后台管理员</span>
                                    {% else %}<span class="badge bg-secondary">普通</span>
                                    {% endif %}
                                </td>
                                <td>{% if user.is_active %}<span class="badge bg-success">是</span>{% else %}<span class="badge bg-danger">否</span>{% endif %}</td>
                                <td>{% if user.first_login %}<span class="badge bg-warning text-dark">是</span>{% else %}<span class="badge bg-success">否</span>{% endif %}</td>
                                <td class="text-end">
                                    {% if protected_admin or protected_super %}
                                        <span class="text-muted small">管理员受保护</span>
                                    {% else %}
                                        <button class="btn btn-outline-primary btn-sm" type="submit" form="user-action-form" formaction="{% url 'management:user_reset' user.id %}" formmethod="post">重置密码</button>
                                        <button class="btn btn-outline-danger btn-sm" type="submit" form="user-action-form" formaction="{% url 'management:user_delete' user.id %}" formmethod="post" onclick="return confirm('确认删除该用户?')">删除</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endwith %}{% endwith %}
                            {% empty %}
                            <tr><td colspan="7" class="text-center text-muted">暂无用户</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
            <nav aria-label="用户分页" class="mt-2 px-3">
                <ul class="pagination mb-2">
                    {% if page_obj.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query }}">上一页</a></li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">上一页</span></li>
                    {% endif %}
                    <li class="page-item disabled"><span class="page-link">第 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 页</span></li>
                    {% if page_obj.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query }}">下一页</a></li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">下一页</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
const STORAGE_KEY = 'management_user_selected_ids';
const CLEAR_FLAG = 'management_user_clear_after_action';
let selectedIds = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

// Clear selection after a completed action redirect
if (sessionStorage.getItem(CLEAR_FLAG)) {
    selectedIds.clear();
    localStorage.removeItem(STORAGE_KEY);
    sessionStorage.removeItem(CLEAR_FLAG);
}

const selectedHidden = document.getElementById('selected-hidden');
const selectAll = document.getElementById('select-all');
const clearSelectionBtn = document.getElementById('clear-selection');
const selectedCountLabel = document.getElementById('selected-count');

function saveSelection() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(selectedIds)));
}

function syncCheckboxes() {
    document.querySelectorAll('input[name="user_ids"]').forEach(cb => {
        cb.checked = selectedIds.has(cb.value);
    });
}

function updateSelectAllState() {
    const checkboxes = Array.from(document.querySelectorAll('input[name="user_ids"]:not(:disabled)'));
    const checked = checkboxes.filter(cb => cb.checked);
    if (!selectAll) return;
    selectAll.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
    selectAll.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
}

function updateCounter() {
    if (selectedCountLabel) {
        selectedCountLabel.textContent = `已选 ${selectedIds.size} 个`;
    }
}

function attachHiddenInputs() {
    if (!selectedHidden) return;
    selectedHidden.innerHTML = '';
    selectedIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'user_ids';
        input.value = id;
        selectedHidden.appendChild(input);
    });
}

function handleCheckboxChange(e) {
    const cb = e.target;
    if (cb.checked) {
        selectedIds.add(cb.value);
    } else {
        selectedIds.delete(cb.value);
    }
    saveSelection();
    updateSelectAllState();
    updateCounter();
}

function initCheckboxes() {
    syncCheckboxes();
    updateSelectAllState();
    updateCounter();
    document.querySelectorAll('input[name="user_ids"]').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
    });
}

if (selectAll) {
    selectAll.addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('input[name="user_ids"]:not(:disabled)');
        checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
            if (cb.checked) {
                selectedIds.add(cb.value);
            } else {
                selectedIds.delete(cb.value);
            }
        });
        saveSelection();
        updateSelectAllState();
        updateCounter();
    });
}

if (clearSelectionBtn) {
    clearSelectionBtn.addEventListener('click', () => {
        selectedIds.clear();
        saveSelection();
        syncCheckboxes();
        updateSelectAllState();
        updateCounter();
    });
}

const actionForm = document.getElementById('user-action-form');
if (actionForm) {
    actionForm.addEventListener('submit', () => {
        sessionStorage.setItem(CLEAR_FLAG, '1');
        attachHiddenInputs();
    });
}

document.addEventListener('DOMContentLoaded', () => {
    initCheckboxes();
});
</script>
{% endblock %}
