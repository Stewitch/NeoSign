{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% if is_edit %}{% trans '编辑活动' %}{% else %}{% trans '创建活动' %}{% endif %} - {{ block.super }}{% endblock %}
{% block content %}
<form method="post">
    {% csrf_token %}
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h3 class="mb-3">{% if is_edit %}{% trans '编辑活动' %}{% else %}{% trans '创建活动' %}{% endif %}</h3>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">{% trans '签到形式' %}</label>
                        <select name="checkin_mode" id="checkin_mode" class="form-select">
                            <option value="basic" {% if not form.instance.location_enabled and not form.instance.qr_enabled %}selected{% endif %}>{% trans '普通' context 'mode' %}</option>
                            <option value="location" {% if form.instance.location_enabled and not form.instance.qr_enabled %}selected{% endif %}>{% trans '位置' %}</option>
                            <option value="qr" {% if form.instance.qr_enabled and not form.instance.location_enabled %}selected{% endif %}>{% trans '二维码' %}</option>
                            <option value="both" {% if form.instance.qr_enabled and form.instance.location_enabled %}selected{% endif %}>{% trans '位置 + 二维码' %}</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">{% trans '名称' %}</label>
                        <input type="text" name="name" class="form-control" value="{{ form.instance.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">{% trans '描述' %}</label>
                        <textarea name="description" class="form-control" rows="3">{{ form.instance.description }}</textarea>
                    </div>

                    <div class="row g-3 mb-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">{% trans '重复方式' %}</label>
                            <select name="repeat_type" id="repeat_type" class="form-select">
                                <option value="none" {% if form.instance.repeat_type == 'none' %}selected{% endif %}>{% trans '不重复' %}</option>
                                <option value="daily" {% if form.instance.repeat_type == 'daily' %}selected{% endif %}>{% trans '每日' %}</option>
                                <option value="weekly" {% if form.instance.repeat_type == 'weekly' %}selected{% endif %}>{% trans '每周' %}</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3" id="block-once">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">{% trans '开始时间' %}</label>
                            <input type="datetime-local" name="start_time" class="form-control" value="{{ form.instance.start_time|date:'Y-m-d\\TH:i' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">{% trans '结束时间' %}</label>
                            <input type="datetime-local" name="end_time" class="form-control" value="{{ form.instance.end_time|date:'Y-m-d\\TH:i' }}">
                        </div>
                    </div>

                    <div class="row g-3" id="block-repeat">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">{% trans '重复起止日期' %}</label>
                            <div class="input-group">
                                <span class="input-group-text">{% trans '开始' %}</span>
                                <input type="date" name="repeat_start_date" class="form-control" value="{{ form.instance.start_time|date:'Y-m-d' }}">
                                <span class="input-group-text">{% trans '结束' %}</span>
                                <input type="date" name="repeat_end_date" class="form-control" value="{% if form.instance.repeat_type != 'none' %}{{ form.instance.end_time|date:'Y-m-d' }}{% endif %}">
                            </div>
                            <div class="form-text">{% trans '结束日期可空，空则长期重复。' %}</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">{% trans '时间窗模式' %}</label>
                            <div class="d-flex gap-3 flex-wrap">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="window_mode" value="range" id="wm_range" checked>
                                    <label class="form-check-label" for="wm_range">{% trans '开始-结束时段' %}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="window_mode" value="duration" id="wm_duration">
                                    <label class="form-check-label" for="wm_duration">{% trans '开始时间 + 持续分钟' %}</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">{% trans '开始时间' %}</label>
                            <input type="time" name="window_start_time" class="form-control" value="{{ form.instance.window_start_time|time:'H:i' }}">
                        </div>
                        <div class="col-md-6" id="window-end-group">
                            <label class="form-label fw-semibold">{% trans '结束时间' %}</label>
                            <input type="time" name="window_end_time" class="form-control" value="{{ form.instance.window_end_time|time:'H:i' }}">
                        </div>
                        <div class="col-md-6 d-none" id="window-duration-group">
                            <label class="form-label fw-semibold">{% trans '持续分钟' %}</label>
                            <input type="number" min="1" name="window_duration_minutes" class="form-control" placeholder="如 60">
                        </div>
                        <div class="col-12" id="weekly-days">
                            <label class="form-label fw-semibold">{% trans '每周重复日' %}</label>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="1" {% if 1 in weekday_selected %}checked{% endif %} id="wd1">
                                    <label class="form-check-label" for="wd1">{% trans '周一' %}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="2" {% if 2 in weekday_selected %}checked{% endif %} id="wd2">
                                    <label class="form-check-label" for="wd2">{% trans '周二' %}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="3" {% if 3 in weekday_selected %}checked{% endif %} id="wd3">
                                    <label class="form-check-label" for="wd3">{% trans '周三' %}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="4" {% if 4 in weekday_selected %}checked{% endif %} id="wd4">
                                    <label class="form-check-label" for="wd4">{% trans '周四' %}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="5" {% if 5 in weekday_selected %}checked{% endif %} id="wd5">
                                    <label class="form-check-label" for="wd5">{% trans '周五' %}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="6" {% if 6 in weekday_selected %}checked{% endif %} id="wd6">
                                    <label class="form-check-label" for="wd6">{% trans '周六' %}</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="7" {% if 7 in weekday_selected %}checked{% endif %} id="wd7">
                                    <label class="form-check-label" for="wd7">{% trans '周日' %}</label>
                                </div>
                            </div>
                            <div class="form-text">{% trans '全选则自动转为每日。' %}</div>
                        </div>
                    </div>

                    <hr/>
                    <div id="block-location" class="d-none">
                        <label class="form-label fw-semibold">{% trans '位置签到' %}</label>
                        <div class="mb-3">
                            <label class="form-label">{% trans '签到范围(米)' %}</label>
                            <input type="number" min="0" name="location_radius_m" class="form-control" value="{{ form.instance.location_radius_m|default:50 }}" required>
                            <div class="form-text">{% trans '设定允许签到的半径范围，签到时会自动判断是否在范围内。' %}</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">{% trans '中心位置' %}</label>
                            <div class="d-flex gap-2 mb-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="use-current-location">
                                    <i class="bi bi-geo-alt-fill"></i> {% trans '使用当前位置' %}
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-location">
                                    {% trans '清除' %}
                                </button>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">{% trans '纬度' %}</label>
                                    <input type="number" step="0.000001" name="location_lat" id="location_lat" class="form-control form-control-sm" value="{{ form.instance.location_lat }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">{% trans '经度' %}</label>
                                    <input type="number" step="0.000001" name="location_lng" id="location_lng" class="form-control form-control-sm" value="{{ form.instance.location_lng }}" readonly>
                                </div>
                            </div>
                            <div class="form-text">{% trans '点击使用当前位置自动获取坐标。若启用地图SDK，下方将显示可视化地图选点界面。' %}</div>
                        </div>

                        <!-- 地图可视化区域：仅当配置了 map_provider 和 map_api_key 时显示 -->
                        {% if config.map_provider and config.map_api_key %}
                        <div id="location-map-container" class="border rounded" style="height: 300px; position: relative;">
                            <div id="location-map" style="width: 100%; height: 100%;"></div>
                        </div>
                        <div class="form-text">{% trans '点击地图标记中心位置，自动更新经纬度坐标。' %}</div>
                        {% else %}
                        <div class="alert alert-info small">
                            {% trans '未配置地图SDK。如需可视化地图选点，请在网站设置中配置地图提供商和API Key。' %}
                        </div>
                        {% endif %}
                    </div>

                    <div id="block-qr" class="d-none">
                        <label class="form-label fw-semibold">{% trans '二维码签到' %}</label>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">{% trans '刷新周期(秒, ≥10)' %}</label>
                                <input type="number" min="10" name="qr_refresh_interval_s" class="form-control" value="{{ form.instance.qr_refresh_interval_s|default:30 }}">
                                <div class="form-text">{% trans '发起者可在二维码展示页实时显示。' %}</div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                {% if is_edit %}
                                    <a class="btn btn-outline-primary" href="{% url 'checkin:qr_presenter' form.instance.id %}">{% trans '打开二维码展示页' %}</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if is_edit %}
                    <div class="form-check form-switch mt-3">
                        <input class="form-check-input" type="checkbox" name="is_active" id="is_active" {% if form.instance.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">{% trans '活动启用' %}</label>
                    </div>
                    {% endif %}

                    <div class="mt-3 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">{% trans '保存' %}</button>
                        <a class="btn btn-secondary" href="{% url 'management:activity_list' %}">{% trans '返回' %}</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-dark text-white py-2 d-flex align-items-center justify-content-between">
                    <span>{% trans '参与用户' %}</span>
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" id="participants-select-all">
                        <label class="form-check-label" for="participants-select-all">{% trans '全选' %}</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 420px; overflow:auto;">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th style="width:48px;"><!-- checkbox column --></th>
                                    <th>{% trans '学号' %}</th>
                                    <th>{% trans '姓名' %}</th>
                                </tr>
                            </thead>
                            <tbody id="participants-table-body">
                                {% for u in users %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="participants" value="{{ u.id }}" {% if u.id in selected_user_ids %}checked{% endif %}>
                                    </td>
                                    <td class="fw-semibold">{{ u.student_id }}</td>
                                    <td>{{ u.first_name|default:'-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <small class="text-muted">{% trans '勾选参与用户，保存后生效。' %}</small>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}
{% block extra_js %}
<script>
function toggleSections() {
    const repeatType = document.getElementById('repeat_type')?.value || 'none';
    const weeklyBlock = document.getElementById('weekly-days');
    const blockRepeat = document.getElementById('block-repeat');
    const blockOnce = document.getElementById('block-once');
    if (repeatType === 'none') {
        blockOnce?.classList.remove('d-none');
        blockRepeat?.classList.add('d-none');
    } else {
        blockOnce?.classList.add('d-none');
        blockRepeat?.classList.remove('d-none');
        if (weeklyBlock) {
            weeklyBlock.classList.toggle('d-none', repeatType !== 'weekly');
        }
    }
}

function toggleWindowMode() {
    const mode = document.querySelector('input[name="window_mode"]:checked')?.value || 'range';
    document.getElementById('window-end-group')?.classList.toggle('d-none', mode !== 'range');
    document.getElementById('window-duration-group')?.classList.toggle('d-none', mode !== 'duration');
}

function toggleCheckinMode() {
    const mode = document.getElementById('checkin_mode')?.value || 'basic';
    document.getElementById('block-location')?.classList.toggle('d-none', !(mode === 'location' || mode === 'both'));
    document.getElementById('block-qr')?.classList.toggle('d-none', !(mode === 'qr' || mode === 'both'));
}

document.getElementById('repeat_type')?.addEventListener('change', toggleSections);
document.querySelectorAll('input[name="window_mode"]').forEach(el => el.addEventListener('change', toggleWindowMode));
document.getElementById('checkin_mode')?.addEventListener('change', toggleCheckinMode);

toggleSections();
toggleWindowMode();
toggleCheckinMode();

const allBox = document.getElementById('participants-select-all');
if (allBox) {
    allBox.addEventListener('change', (e) => {
        document.querySelectorAll('input[name="participants"]').forEach(cb => cb.checked = e.target.checked);
    });
}

// Location handling
const useCurrentBtn = document.getElementById('use-current-location');
const clearBtn = document.getElementById('clear-location');
const latInput = document.getElementById('location_lat');
const lngInput = document.getElementById('location_lng');
const mapProvider = '{{ config.map_provider|default:"" }}';
const mapApiKey = '{{ config.map_api_key|default:"" }}';
let map, marker, circle;

if (useCurrentBtn) {
    useCurrentBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
            alert("{% trans '浏览器不支持地理位置' %}");
            return;
        }
        useCurrentBtn.disabled = true;
        useCurrentBtn.textContent = "{% trans '获取中...' %}";
        navigator.geolocation.getCurrentPosition(
            pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                latInput.value = lat.toFixed(6);
                lngInput.value = lng.toFixed(6);
                useCurrentBtn.disabled = false;
                useCurrentBtn.innerHTML = '<i class="bi bi-geo-alt-fill"></i> {% trans "使用当前位置" %}';
                
                // Update map if SDK available
                if (mapProvider && mapApiKey && map) {
                    updateMapCenter(lat, lng);
                }
            },
            err => {
                alert("{% trans '无法获取位置：' %}" + err.message);
                useCurrentBtn.disabled = false;
                useCurrentBtn.innerHTML = '<i class="bi bi-geo-alt-fill"></i> {% trans "使用当前位置" %}';
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    });
}

if (clearBtn) {
    clearBtn.addEventListener('click', () => {
        latInput.value = '';
        lngInput.value = '';
        if (marker) {
            if (mapProvider === 'amap') marker.setMap(null);
            else if (mapProvider === 'tencent') marker.setMap(null);
            else if (mapProvider === 'google') marker.setMap(null);
        }
        if (circle) {
            if (mapProvider === 'amap') circle.setMap(null);
            else if (mapProvider === 'tencent') circle.setMap(null);
            else if (mapProvider === 'google') circle.setMap(null);
        }
    });
}

// Initialize map if SDK configured
function initMap() {
    const container = document.getElementById('location-map');
    if (!container || !mapProvider || !mapApiKey) return;
    
    const radius = parseInt(document.querySelector('input[name="location_radius_m"]')?.value || 50);
    const lat = parseFloat(latInput.value) || 39.9042;
    const lng = parseFloat(lngInput.value) || 116.4074;
    
    if (mapProvider === 'amap') {
        initAmapMap(lat, lng, radius);
    } else if (mapProvider === 'tencent') {
        initTencentMap(lat, lng, radius);
    } else if (mapProvider === 'google') {
        initGoogleMap(lat, lng, radius);
    }
}

function updateMapCenter(lat, lng) {
    if (!map) return;
    const radius = parseInt(document.querySelector('input[name="location_radius_m"]')?.value || 50);
    
    if (mapProvider === 'amap') {
        map.setCenter([lng, lat]);
        if (marker) marker.setPosition([lng, lat]);
        else marker = new AMap.Marker({ position: [lng, lat], map: map });
        if (circle) {
            circle.setCenter([lng, lat]);
            circle.setRadius(radius);
        } else {
            circle = new AMap.Circle({ center: [lng, lat], radius: radius, map: map, strokeColor: '#3b82f6', strokeWeight: 2, fillColor: '#3b82f6', fillOpacity: 0.25 });
        }
    } else if (mapProvider === 'tencent') {
        map.setCenter(new TMap.LatLng(lat, lng));
        if (marker) marker.setPosition(new TMap.LatLng(lat, lng));
        else marker = new TMap.MultiMarker({ map: map, geometries: [{ position: new TMap.LatLng(lat, lng) }] });
        if (circle) {
            circle.updateGeometries([{ center: new TMap.LatLng(lat, lng), radius: radius }]);
        } else {
            circle = new TMap.MultiCircle({ map: map, geometries: [{ center: new TMap.LatLng(lat, lng), radius: radius }], styles: { default: new TMap.CircleStyle({ color: 'rgba(59, 130, 246, 0.25)', borderColor: '#3b82f6', borderWidth: 2 }) } });
        }
    } else if (mapProvider === 'google') {
        map.setCenter({ lat, lng });
        if (marker) marker.setPosition({ lat, lng });
        else { marker = new google.maps.Marker({ position: { lat, lng }, map: map }); }
        if (circle) {
            circle.setCenter({ lat, lng });
            circle.setRadius(radius);
        } else {
            circle = new google.maps.Circle({ center: { lat, lng }, radius: radius, map: map, strokeColor: '#3b82f6', strokeWeight: 2, fillColor: '#3b82f6', fillOpacity: 0.25 });
        }
    }
}

function initAmapMap(lat, lng, radius) {
    if (typeof AMap === 'undefined') return;
    map = new AMap.Map('location-map', { zoom: 16, center: [lng, lat] });
    marker = new AMap.Marker({ position: [lng, lat], map: map });
    circle = new AMap.Circle({ center: [lng, lat], radius: radius, map: map, strokeColor: '#3b82f6', strokeWeight: 2, fillColor: '#3b82f6', fillOpacity: 0.25 });
    map.on('click', (e) => {
        latInput.value = e.lnglat.lat.toFixed(6);
        lngInput.value = e.lnglat.lng.toFixed(6);
        marker.setPosition([e.lnglat.lng, e.lnglat.lat]);
        circle.setCenter([e.lnglat.lng, e.lnglat.lat]);
    });
}

function initTencentMap(lat, lng, radius) {
    if (typeof TMap === 'undefined') return;
    map = new TMap.Map('location-map', { zoom: 16, center: new TMap.LatLng(lat, lng) });
    marker = new TMap.MultiMarker({ map: map, geometries: [{ position: new TMap.LatLng(lat, lng) }] });
    circle = new TMap.MultiCircle({ map: map, geometries: [{ center: new TMap.LatLng(lat, lng), radius: radius }], styles: { default: new TMap.CircleStyle({ color: 'rgba(59, 130, 246, 0.25)', borderColor: '#3b82f6', borderWidth: 2 }) } });
    map.on('click', (e) => {
        latInput.value = e.latLng.lat.toFixed(6);
        lngInput.value = e.latLng.lng.toFixed(6);
        marker.updateGeometries([{ position: e.latLng }]);
        circle.updateGeometries([{ center: e.latLng, radius: radius }]);
    });
}

function initGoogleMap(lat, lng, radius) {
    if (typeof google === 'undefined') return;
    map = new google.maps.Map(document.getElementById('location-map'), { zoom: 16, center: { lat, lng } });
    marker = new google.maps.Marker({ position: { lat, lng }, map: map });
    circle = new google.maps.Circle({ center: { lat, lng }, radius: radius, map: map, strokeColor: '#3b82f6', strokeWeight: 2, fillColor: '#3b82f6', fillOpacity: 0.25 });
    map.addListener('click', (e) => {
        latInput.value = e.latLng.lat().toFixed(6);
        lngInput.value = e.latLng.lng().toFixed(6);
        marker.setPosition(e.latLng);
        circle.setCenter(e.latLng);
    });
}

// Update circle radius when input changes
document.querySelector('input[name="location_radius_m"]')?.addEventListener('change', (e) => {
    const radius = parseInt(e.target.value) || 50;
    if (circle) {
        if (mapProvider === 'amap') circle.setRadius(radius);
        else if (mapProvider === 'tencent') circle.updateGeometries([{ center: circle.getGeometries()[0].center, radius: radius }]);
        else if (mapProvider === 'google') circle.setRadius(radius);
    }
});

// Load map SDK and initialize
if (mapProvider && mapApiKey) {
    const script = document.createElement('script');
    
    // For AMap, set security config before loading SDK
    if (mapProvider === 'amap') {
        const securityKey = '{{ config.map_security_key|default:"" }}';
        if (securityKey) {
            window._AMapSecurityConfig = {
                securityJsCode: securityKey
            };
        }
        script.src = `https://webapi.amap.com/maps?v=2.0&key=${mapApiKey}`;
    } else if (mapProvider === 'tencent') {
        script.src = `https://map.qq.com/api/gljs?v=1.exp&key=${mapApiKey}`;
    } else if (mapProvider === 'google') {
        script.src = `https://maps.googleapis.com/maps/api/js?key=${mapApiKey}`;
    }
    
    if (script.src) {
        script.onload = initMap;
        document.head.appendChild(script);
    }
}
</script>
{% endblock %}
