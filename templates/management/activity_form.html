{% extends 'base.html' %}
{% block title %}{{ is_edit|default_if_none:False|yesno:'编辑活动,创建活动' }} - {{ block.super }}{% endblock %}
{% block content %}
<form method="post">
    {% csrf_token %}
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h3 class="mb-3">{% if is_edit %}编辑活动{% else %}创建活动{% endif %}</h3>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">签到形式</label>
                        <select name="checkin_mode" id="checkin_mode" class="form-select">
                            <option value="basic" {% if not form.instance.location_enabled and not form.instance.qr_enabled %}selected{% endif %}>普通</option>
                            <option value="location" {% if form.instance.location_enabled and not form.instance.qr_enabled %}selected{% endif %}>位置</option>
                            <option value="qr" {% if form.instance.qr_enabled and not form.instance.location_enabled %}selected{% endif %}>二维码</option>
                            <option value="both" {% if form.instance.qr_enabled and form.instance.location_enabled %}selected{% endif %}>位置 + 二维码</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">名称</label>
                        <input type="text" name="name" class="form-control" value="{{ form.instance.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">描述</label>
                        <textarea name="description" class="form-control" rows="3">{{ form.instance.description }}</textarea>
                    </div>

                    <div class="row g-3" id="block-once">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">开始时间</label>
                            <input type="datetime-local" name="start_time" class="form-control" value="{{ form.instance.start_time|date:'Y-m-d\\TH:i' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">结束时间</label>
                            <input type="datetime-local" name="end_time" class="form-control" value="{{ form.instance.end_time|date:'Y-m-d\\TH:i' }}">
                        </div>
                    </div>

                    <div class="row g-3" id="block-repeat">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">重复方式</label>
                            <select name="repeat_type" id="repeat_type" class="form-select">
                                <option value="none" {% if form.instance.repeat_type == 'none' %}selected{% endif %}>不重复</option>
                                <option value="daily" {% if form.instance.repeat_type == 'daily' %}selected{% endif %}>每日</option>
                                <option value="weekly" {% if form.instance.repeat_type == 'weekly' %}selected{% endif %}>每周</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">重复起止日期</label>
                            <div class="input-group">
                                <span class="input-group-text">开始</span>
                                <input type="date" name="repeat_start_date" class="form-control" value="{{ form.instance.start_time|date:'Y-m-d' }}">
                                <span class="input-group-text">结束</span>
                                <input type="date" name="repeat_end_date" class="form-control" value="{% if form.instance.repeat_type != 'none' %}{{ form.instance.end_time|date:'Y-m-d' }}{% endif %}">
                            </div>
                            <div class="form-text">结束日期可空，空则长期重复。</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">时间窗模式</label>
                            <div class="d-flex gap-3 flex-wrap">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="window_mode" value="range" id="wm_range" checked>
                                    <label class="form-check-label" for="wm_range">开始-结束时段</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="window_mode" value="duration" id="wm_duration">
                                    <label class="form-check-label" for="wm_duration">开始时间 + 持续分钟</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">开始时间</label>
                            <input type="time" name="window_start_time" class="form-control" value="{{ form.instance.window_start_time|time:'H:i' }}">
                        </div>
                        <div class="col-md-6" id="window-end-group">
                            <label class="form-label fw-semibold">结束时间</label>
                            <input type="time" name="window_end_time" class="form-control" value="{{ form.instance.window_end_time|time:'H:i' }}">
                        </div>
                        <div class="col-md-6 d-none" id="window-duration-group">
                            <label class="form-label fw-semibold">持续分钟</label>
                            <input type="number" min="1" name="window_duration_minutes" class="form-control" placeholder="如 60">
                        </div>
                        <div class="col-12" id="weekly-days">
                            <label class="form-label fw-semibold">每周重复日</label>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="1" {% if 1 in weekday_selected %}checked{% endif %} id="wd1">
                                    <label class="form-check-label" for="wd1">周一</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="2" {% if 2 in weekday_selected %}checked{% endif %} id="wd2">
                                    <label class="form-check-label" for="wd2">周二</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="3" {% if 3 in weekday_selected %}checked{% endif %} id="wd3">
                                    <label class="form-check-label" for="wd3">周三</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="4" {% if 4 in weekday_selected %}checked{% endif %} id="wd4">
                                    <label class="form-check-label" for="wd4">周四</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="5" {% if 5 in weekday_selected %}checked{% endif %} id="wd5">
                                    <label class="form-check-label" for="wd5">周五</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="6" {% if 6 in weekday_selected %}checked{% endif %} id="wd6">
                                    <label class="form-check-label" for="wd6">周六</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="repeat_weekdays" value="7" {% if 7 in weekday_selected %}checked{% endif %} id="wd7">
                                    <label class="form-check-label" for="wd7">周日</label>
                                </div>
                            </div>
                            <div class="form-text">全选则自动转为每日。</div>
                        </div>
                    </div>

                    <hr/>
                    <div id="block-location" class="d-none">
                        <label class="form-label fw-semibold">位置签到</label>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">纬度</label>
                                <input type="number" step="0.000001" name="location_lat" class="form-control" value="{{ form.instance.location_lat }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">经度</label>
                                <input type="number" step="0.000001" name="location_lng" class="form-control" value="{{ form.instance.location_lng }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">范围(米)</label>
                                <input type="number" min="0" name="location_radius_m" class="form-control" value="{{ form.instance.location_radius_m }}">
                            </div>
                            <div class="form-text">前端可接入地图 API 获取坐标，后端按半径校验。</div>
                        </div>
                    </div>

                    <div id="block-qr" class="d-none">
                        <label class="form-label fw-semibold">二维码签到</label>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">刷新周期(秒, ≥10)</label>
                                <input type="number" min="10" name="qr_refresh_interval_s" class="form-control" value="{{ form.instance.qr_refresh_interval_s|default:30 }}">
                                <div class="form-text">发起者可在二维码展示页实时显示。</div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                {% if is_edit %}
                                    <a class="btn btn-outline-primary" href="{% url 'checkin:qr_presenter' form.instance.id %}">打开二维码展示页</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if is_edit %}
                    <div class="form-check form-switch mt-3">
                        <input class="form-check-input" type="checkbox" name="is_active" id="is_active" {% if form.instance.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">活动启用</label>
                    </div>
                    {% endif %}

                    <div class="mt-3 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <a class="btn btn-secondary" href="{% url 'management:activity_list' %}">返回</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-dark text-white py-2 d-flex align-items-center justify-content-between">
                    <span>参与用户</span>
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" id="participants-select-all">
                        <label class="form-check-label" for="participants-select-all">全选</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 420px; overflow:auto;">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th style="width:48px;"><!-- checkbox column --></th>
                                    <th>学号</th>
                                    <th>姓名</th>
                                </tr>
                            </thead>
                            <tbody id="participants-table-body">
                                {% for u in users %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="participants" value="{{ u.id }}" {% if u.id in selected_user_ids %}checked{% endif %}>
                                    </td>
                                    <td class="fw-semibold">{{ u.student_id }}</td>
                                    <td>{{ u.first_name|default:'-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <small class="text-muted">勾选参与用户，保存后生效。</small>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}
{% block extra_js %}
<script>
function toggleSections() {
    const repeatType = document.getElementById('repeat_type')?.value || 'none';
    const weeklyBlock = document.getElementById('weekly-days');
    const blockRepeat = document.getElementById('block-repeat');
    const blockOnce = document.getElementById('block-once');
    if (repeatType === 'none') {
        blockOnce?.classList.remove('d-none');
        blockRepeat?.classList.add('d-none');
    } else {
        blockOnce?.classList.add('d-none');
        blockRepeat?.classList.remove('d-none');
        if (weeklyBlock) {
            weeklyBlock.classList.toggle('d-none', repeatType !== 'weekly');
        }
    }
}

function toggleWindowMode() {
    const mode = document.querySelector('input[name="window_mode"]:checked')?.value || 'range';
    document.getElementById('window-end-group')?.classList.toggle('d-none', mode !== 'range');
    document.getElementById('window-duration-group')?.classList.toggle('d-none', mode !== 'duration');
}

function toggleCheckinMode() {
    const mode = document.getElementById('checkin_mode')?.value || 'basic';
    document.getElementById('block-location')?.classList.toggle('d-none', !(mode === 'location' || mode === 'both'));
    document.getElementById('block-qr')?.classList.toggle('d-none', !(mode === 'qr' || mode === 'both'));
}

document.getElementById('repeat_type')?.addEventListener('change', toggleSections);
document.querySelectorAll('input[name="window_mode"]').forEach(el => el.addEventListener('change', toggleWindowMode));
document.getElementById('checkin_mode')?.addEventListener('change', toggleCheckinMode);

toggleSections();
toggleWindowMode();
toggleCheckinMode();

const allBox = document.getElementById('participants-select-all');
if (allBox) {
    allBox.addEventListener('change', (e) => {
        document.querySelectorAll('input[name="participants"]').forEach(cb => cb.checked = e.target.checked);
    });
}
</script>
{% endblock %}
